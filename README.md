# firmware for qr-scanner и card-colum

### target:
обеспечить взаимодействие с сервером(java) по управлению и администрированию вьезда/выезда с данными устройствами

# Общие требования к прошивке

### Общее описание:
Требуется прошивка для системы устройств, состоящей из сканера QR меток (через COM-port) и коллон предназначенных для выдачи карт. Также прошивка должна иметь возможность отправлять и принимать HTTP запросы на/от ниже описанных endpoint-в. Краткое описание деятельности системы: сканер qr сканирует на вьезде имеющийся у водителя qr-code(внутри qr кода есть метаданные в формате json, которые необходимо передать на сервер), если данный qr проходит проверку, то надо послать команду в колонну на выдачу карты и оповестить об этом сервер, после этого открыть шлагбаум. Также существуют негативные кейсы, например отсутствие qr кода в базе данных на сервере или неисправность шлагбаума, или неисправность колонны, либо отсутствие коннекта с сервером и тд.
Для случаев критической неисправности каких то устройств в системе существует endpoint "/api/report", в который можно сообщить какое устройство вышло из строя.

### Необходимые требования:
1. Возможность тестировать функциональность прошивки локально с адресом платы localhost:8181 (или в качестве аргументов при запуске самостоятельно передавать host и port)
2. В случае если плата переживает экстренное выключение питания и программа приостанавливается, желательно посылать в "/api/report" ID устройства.
3. необходимое количество retry в случае если действие выполнено неуспешно

---

### описание работы базового функционала:
#### Запрос на осуществление въезда на предприятие - `POST api/qrScanner/checkQrForEntry`
метод который нужно вызывать в момент считывания qr(когда на въезде водитель подносит qr-code к считывающему устройству), тем самым запрашивая въезд на территорию предприятия.

**Примечание:** после считывания qr, содержимое qr передается в формате json(в текущей реализации в не зашифрованном виде) через comport.

**Список параметров:**
```sh
{
    "id": 50,
    "governmentNumber": "у146за",
    "name": "test_name",
    "surname": "test_surname",
    "expire": true
}
```

**Формат ответа:**
```sh
50 - id проверяемого qr code(в формате long)
```

**Статус:**

1. при успешной отработке - `HttpStatus.OK(200)`
2. при возникновении ошибки(например невалидный qr) - `HttpStatus.Forbidden(403)`
3. сервер недоступен - `HttpStatus.Internal_Server_Error(500)`

#### Оповещение о том, что карта выдана - `POST /api/cardColumn/giveCard`
данный метод должен вызываться после успешной выдачи карты посетителю(когда qr оказался валидным, после получения статуса 200 от `api/qrScanner/checkQrForEntry`), после успешной выдачи передается **result:** true или **result:** false в случае неуспешной выдачи. Имеет смысл обьединять данное действие с событием считывания qr(чтобы иметь возможность откатить транзакцию целиком)

**Список параметров:**
```sh
{
    "id": 50 - id qr кода,
    "result": true
    "cardNumber": "123456" - заполняется только при успешной выдачи
}
```

**Формат ответа:**
```sh
50 - id проверяемого qr code(в формате long)
```

**Статус:**
1. при успешной отработке - `HttpStatus.OK(200)`
2. сервер недоступен - `HttpStatus.Internal_Server_Error(500)`

#### Оповещение о том, что карта принята обратно в колонну - `POST /api/cardColumn/takeCard`
данный метод должен вызываться после получения колонной карты на выезде, после успешной выдачи передается **result:** true или **result:** false в случае неуспешного приема карт.

**Список параметров:**
```sh
{
    "id": 50 - id qr кода,
    "result": true
    "cardNumber": "123456" - заполняется только при успешной выдачи
}
```

**Формат ответа:**
```sh
50 - id карточки
```

**Статус:**
1. при успешной отработке - `HttpStatus.OK(200)`
2. сервер недоступен - `HttpStatus.Internal_Server_Error(500)`

#### Оповещение о том, что карт в колонне становится критически мало  - `POST /api/cardColumn/lowCountCards`
на плате периодически происходит проверка кол-ва карт в колоннах. Если количество карт становится меньше критического, то посылаем алерт на сервер.

**Список параметров:**
```sh
{
    "id": 50 - id устройства,
}
```

**Формат ответа:**
```sh
не предусматривает ответ от сервера
```

**Статус:**
1. при успешной отработке - `HttpStatus.OK(200)`
2. сервер недоступен - `HttpStatus.Internal_Server_Error(500)`

### Регистрация платы внутри программы - `POST /api/registration` - запрос с платы на сервер
Метод предназначенный для регистрации платы в нашей программе для дальнейшей идентификации плат и подконтрольных им устройств во время работы. Внутри платы должен быть флажок, что плата зарегистрирована, и плата должна совершать запросы на сервер до тех пор, пока не зарегистрируется успешно.

**Список параметров:**
`@RequestBody BoardRegisterDto` - объект, содержащий 3 поля:
http_address - адрес платы, в строчном формате, например "http://192.168.0.100:8080",
device_id - идентификатор устройства ("IN", "OUT"),
coordinates - координаты платы в формате строки: "55.993651, 37.183600"

**Формат запроса:**
```
{
     "http_address": "http://192.168.0.100:8080",
     "device_id": "OUT",
     "coordinates": "55.993651, 37.183600"
}
```

**Формат ответа:**
HTTP Status 200 - в случае успешной регистрации,
HTTP Status 400 - в случае неудачной регистрации.

### Сообщение о критической ошибке модуля - `POST /api/report` - запрос с платы на сервер
Метод предназначенный для сообщения в приложение о критических ошибках работы шлагбаума или считывателя RFID меток.
В данный метод нужно посылать запрос до получения статуса 200, чтобы убедиться в том, что наш сервер узнал о критической ошибке какого либо устройства.

**Список параметров:**
`@RequestParam {String report}` - содержащая индетификатор неисправного устройства.

**Формат ответа:**
HTTP Status 200 - в случае успешного получения сервером информации.

**Возможные ошибки**
В случае недоступности сервера HTTP Status 500.
